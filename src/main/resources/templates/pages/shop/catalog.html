<!DOCTYPE html>
<html lang="id" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Belanja - MiniShop</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>body { font-family: 'Plus Jakarta Sans', sans-serif; }</style>
</head>
<body class="bg-gray-50 text-slate-800">

    <!-- NAVBAR -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-indigo-600 rounded flex items-center justify-center text-white"><i class="fas fa-shopping-bag"></i></div>
                <span class="font-bold text-xl text-slate-900">MiniShop</span>
            </div>
            
            <div class="flex items-center gap-4">
                <a href="/shop/my-orders" class="text-sm font-medium text-slate-600 hover:text-indigo-600">Pesanan Saya</a>
                
                <!-- Cart Button -->
                <button onclick="toggleCart()" class="relative p-2 text-slate-500 hover:text-indigo-600 transition">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cartBadge" class="hidden absolute top-0 right-0 w-4 h-4 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center">0</span>
                </button>

                <div class="h-6 w-px bg-gray-300"></div>
                
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold text-slate-700" th:text="${auth.fullName}">User</span>
                    <button onclick="logout()" class="text-red-500 hover:text-red-700"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <!-- CONTENT -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Banner -->
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-2xl p-8 text-white shadow-lg mb-8">
            <h1 class="text-3xl font-bold mb-2">Mau cari apa hari ini?</h1>
            <p class="text-indigo-100">Dapatkan produk berkualitas dengan harga terbaik.</p>
        </div>

        <!-- Grid Produk -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div th:each="prod : ${products}" class="bg-white rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition overflow-hidden group">
                <div class="h-48 bg-gray-100 relative">
                    <img th:if="${prod.image}" th:src="@{'/uploads/' + ${prod.image}}" class="w-full h-full object-cover">
                    <div th:unless="${prod.image}" class="w-full h-full flex items-center justify-center text-slate-300"><i class="fas fa-image text-3xl"></i></div>
                    <span class="absolute top-2 right-2 bg-white/90 backdrop-blur px-2 py-1 rounded text-xs font-bold text-slate-700" th:text="${prod.stock} + ' stok'"></span>
                </div>
                
                <div class="p-4">
                    <p class="text-xs text-indigo-600 font-bold uppercase mb-1" th:text="${prod.category}">Kategori</p>
                    <h3 class="font-bold text-slate-900 mb-3 truncate" th:text="${prod.name}">Produk</h3>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-lg font-bold text-slate-800" th:text="'Rp ' + ${#numbers.formatDecimal(prod.price, 0, 'COMMA', 0, 'POINT')}">Rp 0</span>
                        
                        <!-- Add to Cart Button -->
                        <button th:if="${prod.stock > 0}"
                                th:onclick="addToCart([[${prod.id}]], [[${prod.name}]], [[${prod.price}]], [[${prod.stock}]])"
                                class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center hover:bg-indigo-600 hover:text-white transition">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span th:if="${prod.stock == 0}" class="text-xs text-red-500 font-bold">Habis</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- SIDEBAR CART -->
    <div id="cartSidebar" class="fixed inset-y-0 right-0 w-full sm:w-96 bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-4 border-b flex justify-between items-center bg-gray-50">
            <h2 class="font-bold text-lg"><i class="fas fa-shopping-basket mr-2 text-indigo-600"></i>Keranjang</h2>
            <button onclick="toggleCart()" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
        </div>
        
        <div id="cartItems" class="flex-1 overflow-y-auto p-4 space-y-4">
            <!-- Items injected by JS -->
            <div class="text-center text-gray-400 mt-10">Keranjang kosong</div>
        </div>

        <div class="p-4 border-t bg-gray-50">
            <div class="flex justify-between font-bold text-lg mb-4">
                <span>Total</span>
                <span id="cartTotal">Rp 0</span>
            </div>
            <button onclick="checkout()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-xl font-bold transition shadow-lg shadow-indigo-200">
                Checkout Sekarang
            </button>
        </div>
    </div>
    
    <!-- Overlay -->
    <div id="overlay" onclick="toggleCart()" class="fixed inset-0 bg-black/50 z-40 hidden transition-opacity"></div>

    <!-- JAVASCRIPT -->
    <script th:inline="javascript">
        let cart = [];
        const userName = /*[[${auth.fullName}]]*/ 'User';

        function addToCart(id, name, price, maxStock) {
            const item = cart.find(i => i.productId === id);
            if (item) {
                if(item.quantity >= maxStock) {
                    Swal.fire('Stok Habis', 'Maksimal stok tercapai', 'warning');
                    return;
                }
                item.quantity++;
            } else {
                cart.push({ productId: id, name: name, price: price, quantity: 1, maxStock: maxStock });
            }
            renderCart();
            
            // Auto open cart
            const sidebar = document.getElementById('cartSidebar');
            if (sidebar.classList.contains('translate-x-full')) toggleCart();
        }

        function updateQty(index, delta) {
            const item = cart[index];
            const newQty = item.quantity + delta;
            
            if (newQty <= 0) cart.splice(index, 1);
            else if (newQty > item.maxStock) Swal.fire('Limit', 'Stok tidak cukup', 'warning');
            else item.quantity = newQty;
            
            renderCart();
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            const totalEl = document.getElementById('cartTotal');
            const badge = document.getElementById('cartBadge');
            
            let total = 0;
            let count = 0;
            let html = '';

            cart.forEach((item, index) => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                count += item.quantity;

                html += `
                    <div class="flex justify-between items-center bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                        <div class="flex-1">
                            <h4 class="font-bold text-sm text-slate-800 line-clamp-1">${item.name}</h4>
                            <p class="text-xs text-slate-500">@ Rp ${item.price.toLocaleString('id-ID')}</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center border rounded-lg">
                                <button onclick="updateQty(${index}, -1)" class="px-2 py-1 text-slate-500 hover:bg-gray-100">-</button>
                                <span class="text-sm font-bold w-4 text-center">${item.quantity}</span>
                                <button onclick="updateQty(${index}, 1)" class="px-2 py-1 text-slate-500 hover:bg-gray-100">+</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = cart.length ? html : '<div class="text-center text-gray-400 mt-10">Keranjang kosong</div>';
            totalEl.innerText = 'Rp ' + total.toLocaleString('id-ID');
            badge.innerText = count;
            badge.classList.toggle('hidden', count === 0);
        }

        function toggleCart() {
            const sidebar = document.getElementById('cartSidebar');
            const overlay = document.getElementById('overlay');
            sidebar.classList.toggle('translate-x-full');
            overlay.classList.toggle('hidden');
        }

        function checkout() {
    if (cart.length === 0) {
        Swal.fire({
            icon: 'info',
            title: 'Keranjang Kosong',
            text: 'Tambahkan produk terlebih dahulu sebelum checkout',
            confirmButtonColor: '#4F46E5'
        });
        return;
    }

    // Validasi stok sebelum checkout
    let stockValid = true;
    let stockError = '';
    
    cart.forEach(item => {
        if (item.quantity > item.maxStock) {
            stockValid = false;
            stockError = `${item.name} hanya tersedia ${item.maxStock} stok`;
        }
    });
    
    if (!stockValid) {
        Swal.fire({
            icon: 'warning',
            title: 'Stok Tidak Cukup',
            text: stockError,
            confirmButtonColor: '#F59E0B'
        });
        return;
    }

    // Show checkout confirmation
    Swal.fire({
        title: 'Konfirmasi Checkout',
        html: `
            <div class="text-left">
                <p class="mb-2">Anda akan membeli:</p>
                <ul class="list-disc pl-4 mb-3">
                    ${cart.map(item => 
                        `<li>${item.name} (${item.quantity}x)</li>`
                    ).join('')}
                </ul>
                <p class="font-bold">Total: Rp ${cart.reduce((sum, item) => sum + (item.price * item.quantity), 0).toLocaleString('id-ID')}</p>
            </div>
        `,
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#4F46E5',
        cancelButtonColor: '#64748b',
        confirmButtonText: 'Ya, Checkout',
        cancelButtonText: 'Batal',
        reverseButtons: true,
        showLoaderOnConfirm: true,
        preConfirm: async () => {
            try {
                // Payload sesuai DTO OrderRequestDto
                const payload = {
                    customerName: userName,
                    items: cart.map(i => ({ 
                        productId: i.productId, 
                        quantity: i.quantity 
                    }))
                };

                const token = document.cookie.split('; ').find(row => row.startsWith('AUTH_TOKEN='))?.split('=')[1] || '';

                const response = await fetch('/api/orders', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json', 
                        'Authorization': token ? `Bearer ${token}` : '' 
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.message || 'Terjadi kesalahan saat checkout');
                }
                
                return data;
            } catch (error) {
                Swal.showValidationMessage(`Error: ${error.message}`);
                return false;
            }
        },
        allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
        if (result.isConfirmed && result.value) {
            // Kosongkan keranjang
            cart = [];
            renderCart();
            toggleCart();
            
            // Tampilkan sukses
            Swal.fire({
                icon: 'success',
                title: 'Checkout Berhasil!',
                html: `
                    <div class="text-center">
                        <div class="w-16 h-16 mx-auto mb-4 bg-green-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-check text-green-600 text-2xl"></i>
                        </div>
                        <p class="mb-2">Pesanan Anda telah berhasil dibuat</p>
                        <p class="text-sm text-gray-500">ID Pesanan: #${result.value.data?.id || '0000'}</p>
                    </div>
                `,
                confirmButtonColor: '#10B981',
                confirmButtonText: 'Lihat Pesanan Saya'
            }).then(() => {
                window.location.href = '/shop/my-orders';
            });
        }
    });
}

        function logout() {
            Swal.fire({
                title: 'Keluar dari MiniShop?',
                text: "Keranjang belanja Anda mungkin tersimpan.",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#ef4444', // Red
                cancelButtonColor: '#64748b',  // Slate
                confirmButtonText: 'Ya, Keluar',
                cancelButtonText: 'Batal',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    // Animasi Loading
                    Swal.fire({
                        title: 'Sedang keluar...',
                        html: 'Terima kasih telah berbelanja!',
                        timer: 1000,
                        timerProgressBar: true,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    }).then(() => {
                        // Hapus Sesi
                        document.cookie = "AUTH_TOKEN=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                        localStorage.removeItem('token');
                        
                        // Redirect ke Server Logout
                        window.location.href = "/auth/logout";
                    });
                }
            });
        }
    </script>
</body>
</html>